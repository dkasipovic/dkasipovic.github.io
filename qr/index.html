<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="description" content="Generate customizable QR codes with logos, colors, and frames. Save presets and brand kits. Works offline.">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="QR Studio">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>QR Studio</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --bg-primary: #0a0a0f; --bg-secondary: #12121a; --bg-tertiary: #1a1a24; --bg-elevated: #22222e;
            --border: #2a2a3a; --border-hover: #3a3a4a;
            --text-primary: #f0f0f5; --text-secondary: #a0a0b0; --text-muted: #606070;
            --accent: #6366f1; --accent-hover: #818cf8; --accent-subtle: rgba(99, 102, 241, 0.15);
            --success: #22c55e; --warning: #f59e0b; --error: #ef4444;
            --radius-sm: 6px; --radius-md: 10px; --radius-lg: 16px;
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.4); --transition: 0.2s ease;
        }
        [data-theme="light"] {
            --bg-primary: #f8f8fc; --bg-secondary: #ffffff; --bg-tertiary: #f0f0f5; --bg-elevated: #ffffff;
            --border: #e0e0e8; --border-hover: #d0d0d8;
            --text-primary: #1a1a24; --text-secondary: #505060; --text-muted: #909098;
            --accent: #4f46e5; --accent-hover: #6366f1; --accent-subtle: rgba(79, 70, 229, 0.1);
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
        }
        html { font-size: 15px; }
        body { font-family: 'DM Sans', -apple-system, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; line-height: 1.5; }
        
        .header { display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); background: var(--bg-secondary); position: sticky; top: 0; z-index: 100; }
        .logo { display: flex; align-items: center; gap: 0.75rem; font-weight: 700; font-size: 1.25rem; letter-spacing: -0.02em; }
        .logo svg { width: 32px; height: 32px; }
        .header-actions { display: flex; align-items: center; gap: 0.5rem; }
        
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.6rem 1rem; border: 1px solid var(--border); border-radius: var(--radius-md); background: var(--bg-tertiary); color: var(--text-primary); font-family: inherit; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all var(--transition); white-space: nowrap; }
        .btn:hover { background: var(--bg-elevated); border-color: var(--border-hover); }
        .btn-icon { padding: 0.6rem; min-width: 40px; }
        .btn-primary { background: var(--accent); border-color: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); border-color: var(--accent-hover); }
        .btn svg { width: 18px; height: 18px; flex-shrink: 0; }
        
        .main { display: grid; grid-template-columns: 1fr 1fr; min-height: calc(100vh - 65px); }
        @media (max-width: 900px) { .main { grid-template-columns: 1fr; } }
        
        .form-panel { padding: 1.5rem; border-right: 1px solid var(--border); overflow-y: auto; max-height: calc(100vh - 65px); }
        @media (max-width: 900px) { .form-panel { border-right: none; border-bottom: 1px solid var(--border); max-height: none; } }
        
        .type-selector { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem; }
        .type-btn { padding: 0.5rem 0.9rem; border: 1px solid var(--border); border-radius: var(--radius-md); background: var(--bg-tertiary); color: var(--text-secondary); font-family: inherit; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all var(--transition); }
        .type-btn:hover { border-color: var(--border-hover); color: var(--text-primary); }
        .type-btn.active { background: var(--accent-subtle); border-color: var(--accent); color: var(--accent); }
        
        .section { margin-bottom: 1rem; border: 1px solid var(--border); border-radius: var(--radius-lg); background: var(--bg-secondary); overflow: hidden; }
        .section-header { display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.25rem; cursor: pointer; user-select: none; transition: background var(--transition); }
        .section-header:hover { background: var(--bg-tertiary); }
        .section-title { display: flex; align-items: center; gap: 0.75rem; font-weight: 600; font-size: 0.95rem; }
        .section-title svg { width: 18px; height: 18px; color: var(--text-muted); }
        .section-toggle { width: 20px; height: 20px; color: var(--text-muted); transition: transform var(--transition); }
        .section.open .section-toggle { transform: rotate(180deg); }
        .section-content { display: none; padding: 0 1.25rem 1.25rem; }
        .section.open .section-content { display: block; }
        
        .field { margin-bottom: 1rem; }
        .field:last-child { margin-bottom: 0; }
        .field-label { display: block; margin-bottom: 0.4rem; font-size: 0.85rem; font-weight: 500; color: var(--text-secondary); }
        .field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        
        input[type="text"], input[type="url"], input[type="email"], input[type="tel"], input[type="number"], textarea, select {
            width: 100%; padding: 0.7rem 0.9rem; border: 1px solid var(--border); border-radius: var(--radius-md);
            background: var(--bg-tertiary); color: var(--text-primary); font-family: inherit; font-size: 0.9rem; transition: all var(--transition);
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-subtle); }
        textarea { resize: vertical; min-height: 80px; }
        select { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23606070' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.75rem center; padding-right: 2.5rem; }
        
        .color-field { display: flex; align-items: center; gap: 0.75rem; }
        .color-picker-wrapper { position: relative; width: 44px; height: 44px; flex-shrink: 0; }
        input[type="color"] { position: absolute; inset: 0; width: 100%; height: 100%; padding: 0; border: 2px solid var(--border); border-radius: var(--radius-md); cursor: pointer; background: none; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 3px; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 4px; }
        .color-hex { flex: 1; font-family: 'JetBrains Mono', monospace; text-transform: uppercase; }
        
        .checkbox-field { display: flex; align-items: center; gap: 0.75rem; cursor: pointer; }
        .checkbox-field input { width: 20px; height: 20px; accent-color: var(--accent); cursor: pointer; }
        
        .range-field { display: flex; align-items: center; gap: 1rem; }
        input[type="range"] { flex: 1; height: 6px; border-radius: 3px; background: var(--bg-tertiary); appearance: none; cursor: pointer; }
        input[type="range"]::-webkit-slider-thumb { appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--accent); cursor: pointer; transition: transform var(--transition); }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.15); }
        .range-value { min-width: 60px; padding: 0.4rem 0.6rem; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-tertiary); font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; text-align: center; }
        
        .style-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; }
        .style-option { aspect-ratio: 1; border: 2px solid var(--border); border-radius: var(--radius-md); background: var(--bg-tertiary); cursor: pointer; transition: all var(--transition); display: flex; align-items: center; justify-content: center; padding: 0.5rem; }
        .style-option:hover { border-color: var(--border-hover); }
        .style-option.active { border-color: var(--accent); background: var(--accent-subtle); }
        .style-option svg { width: 100%; height: 100%; color: var(--text-primary); }
        
        .logo-upload { border: 2px dashed var(--border); border-radius: var(--radius-md); padding: 1.5rem; text-align: center; cursor: pointer; transition: all var(--transition); }
        .logo-upload:hover { border-color: var(--accent); background: var(--accent-subtle); }
        .logo-upload.has-logo { border-style: solid; padding: 0.75rem; }
        .logo-upload input { display: none; }
        .logo-upload svg { width: 32px; height: 32px; color: var(--text-muted); margin-bottom: 0.5rem; }
        .logo-upload p { font-size: 0.85rem; color: var(--text-secondary); }
        .logo-preview { display: flex; align-items: center; gap: 1rem; }
        .logo-preview img { width: 64px; height: 64px; object-fit: contain; border-radius: var(--radius-sm); background: white; }
        .logo-preview-info { flex: 1; text-align: left; }
        .logo-preview-name { font-weight: 500; font-size: 0.9rem; margin-bottom: 0.25rem; word-break: break-all; }
        .logo-preview-remove { color: var(--error); font-size: 0.8rem; cursor: pointer; }
        .logo-preview-remove:hover { text-decoration: underline; }
        
        .preview-panel { display: flex; flex-direction: column; padding: 1.5rem; background: var(--bg-secondary); }
        .preview-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; }
        .qr-wrapper { background: white; padding: 1rem; border-radius: var(--radius-lg); box-shadow: var(--shadow); }
        .qr-wrapper.transparent-bg { background: repeating-conic-gradient(#e0e0e0 0% 25%, white 0% 50%) 50% / 16px 16px; }
        #qr-code { display: block; }
        #qr-code canvas, #qr-code svg { display: block; }
        .frame-label { margin-top: 0.75rem; padding: 0.5rem 1rem; background: var(--bg-primary); color: var(--text-primary); font-weight: 600; font-size: 0.85rem; letter-spacing: 0.1em; text-transform: uppercase; border-radius: var(--radius-sm); text-align: center; }
        
        .status-bar { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem; padding: 1rem; border: 1px solid var(--border); border-radius: var(--radius-md); background: var(--bg-tertiary); }
        .status-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; }
        .status-item svg { width: 16px; height: 16px; }
        .status-ok { color: var(--success); }
        .status-warning { color: var(--warning); }
        .status-error { color: var(--error); }
        .capacity-bar { flex: 1; min-width: 150px; }
        .capacity-bar-track { height: 6px; background: var(--bg-elevated); border-radius: 3px; overflow: hidden; margin-top: 0.25rem; }
        .capacity-bar-fill { height: 100%; background: var(--accent); border-radius: 3px; transition: width var(--transition), background var(--transition); }
        .capacity-bar-fill.warning { background: var(--warning); }
        .capacity-bar-fill.error { background: var(--error); }
        
        .download-actions { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); }
        .download-actions .btn { flex: 1; min-width: 100px; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; padding: 1rem; z-index: 1000; opacity: 0; visibility: hidden; transition: all var(--transition); }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-lg); width: 100%; max-width: 500px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; transform: scale(0.95); transition: transform var(--transition); }
        .modal-overlay.open .modal { transform: scale(1); }
        .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); }
        .modal-title { font-weight: 600; font-size: 1.1rem; }
        .modal-close { width: 32px; height: 32px; border: none; border-radius: var(--radius-sm); background: transparent; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all var(--transition); }
        .modal-close:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .modal-body { padding: 1.25rem; overflow-y: auto; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 0.5rem; padding: 1rem 1.25rem; border-top: 1px solid var(--border); }
        
        .preset-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .preset-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius-md); background: var(--bg-tertiary); cursor: pointer; transition: all var(--transition); }
        .preset-item:hover { border-color: var(--accent); background: var(--accent-subtle); }
        .preset-preview { width: 48px; height: 48px; border-radius: var(--radius-sm); background: white; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .preset-info { flex: 1; min-width: 0; }
        .preset-name { font-weight: 500; margin-bottom: 0.15rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .preset-type { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .preset-delete { padding: 0.4rem; border: none; border-radius: var(--radius-sm); background: transparent; color: var(--text-muted); cursor: pointer; transition: all var(--transition); }
        .preset-delete:hover { background: rgba(239, 68, 68, 0.15); color: var(--error); }
        .empty-state { text-align: center; padding: 2rem; color: var(--text-muted); }
        .empty-state svg { width: 48px; height: 48px; margin-bottom: 1rem; opacity: 0.5; }
        
        .dropdown { position: relative; }
        .dropdown-menu { position: absolute; top: calc(100% + 0.5rem); right: 0; min-width: 180px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-md); box-shadow: var(--shadow); z-index: 50; opacity: 0; visibility: hidden; transform: translateY(-0.5rem); transition: all var(--transition); }
        .dropdown.open .dropdown-menu { opacity: 1; visibility: visible; transform: translateY(0); }
        .dropdown-item { display: flex; align-items: center; gap: 0.75rem; width: 100%; padding: 0.7rem 1rem; border: none; background: transparent; color: var(--text-primary); font-family: inherit; font-size: 0.9rem; text-align: left; cursor: pointer; transition: background var(--transition); }
        .dropdown-item:hover { background: var(--bg-tertiary); }
        .dropdown-item svg { width: 16px; height: 16px; color: var(--text-muted); }
        .dropdown-divider { height: 1px; background: var(--border); margin: 0.25rem 0; }
        
        .toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 1001; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { padding: 0.75rem 1rem; border-radius: var(--radius-md); background: var(--bg-elevated); border: 1px solid var(--border); box-shadow: var(--shadow); display: flex; align-items: center; gap: 0.75rem; font-size: 0.9rem; animation: toast-in 0.3s ease; }
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--error); }
        .toast svg { width: 18px; height: 18px; flex-shrink: 0; }
        .toast.success svg { color: var(--success); }
        .toast.error svg { color: var(--error); }
        @keyframes toast-in { from { opacity: 0; transform: translateY(1rem); } to { opacity: 1; transform: translateY(0); } }
        
        .hidden { display: none !important; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--border-hover); }
        
        .install-banner { display: none; padding: 0.75rem 1.25rem; background: var(--accent-subtle); border-bottom: 1px solid var(--accent); align-items: center; justify-content: space-between; gap: 1rem; }
        .install-banner.show { display: flex; }
        .install-banner p { font-size: 0.9rem; }
        .install-banner-actions { display: flex; gap: 0.5rem; }
        .install-banner .btn-dismiss { padding: 0.4rem 0.75rem; font-size: 0.85rem; }
    </style>
</head>
<body>
    <div class="install-banner" id="installBanner">
        <p>ðŸ“± Install QR Studio for quick access</p>
        <div class="install-banner-actions">
            <button class="btn btn-primary btn-sm" id="installBtn">Install</button>
            <button class="btn btn-dismiss" id="dismissInstall">Dismiss</button>
        </div>
    </div>

    <header class="header">
        <div class="logo">
            <svg viewBox="0 0 32 32" fill="none"><rect x="2" y="2" width="10" height="10" rx="2" fill="currentColor"/><rect x="20" y="2" width="10" height="10" rx="2" fill="currentColor"/><rect x="2" y="20" width="10" height="10" rx="2" fill="currentColor"/><rect x="14" y="14" width="4" height="4" rx="1" fill="currentColor"/><rect x="22" y="22" width="6" height="6" rx="1" fill="currentColor"/><rect x="14" y="22" width="4" height="4" rx="1" fill="currentColor"/><rect x="22" y="14" width="4" height="4" rx="1" fill="currentColor"/></svg>
            QR Studio
        </div>
        <div class="header-actions">
            <div class="dropdown" id="presetsDropdown">
                <button class="btn" id="presetsBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
                    <span class="btn-text">Presets</span>
                </button>
                <div class="dropdown-menu">
                    <button class="dropdown-item" id="savePresetBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>Save Current</button>
                    <button class="dropdown-item" id="loadPresetBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>Load Preset</button>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item" id="exportPresetsBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export All</button>
                    <button class="dropdown-item" id="importPresetsBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Import</button>
                </div>
            </div>
            <div class="dropdown" id="brandDropdown">
                <button class="btn" id="brandBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                    <span class="btn-text">Brand</span>
                </button>
                <div class="dropdown-menu">
                    <button class="dropdown-item" id="saveBrandBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>Save Brand Kit</button>
                    <button class="dropdown-item" id="applyBrandBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>Apply Brand</button>
                    <button class="dropdown-item" id="clearBrandBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>Clear Brand</button>
                </div>
            </div>
            <button class="btn btn-icon" id="themeToggle" title="Toggle theme">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon-moon hidden"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
            </button>
            <button class="btn btn-icon" id="shareBtn" title="Share link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
            </button>
        </div>
    </header>

    <main class="main">
        <div class="form-panel">
            <div class="type-selector" id="typeSelector">
                <button class="type-btn active" data-type="url">URL</button>
                <button class="type-btn" data-type="text">Text</button>
                <button class="type-btn" data-type="vcard">vCard</button>
                <button class="type-btn" data-type="wifi">WiFi</button>
                <button class="type-btn" data-type="email">Email</button>
                <button class="type-btn" data-type="sms">SMS</button>
                <button class="type-btn" data-type="phone">Phone</button>
                <button class="type-btn" data-type="geo">Location</button>
            </div>

            <div class="section open" id="contentSection">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>Content</div>
                    <svg class="section-toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div class="section-content">
                    <div class="form-content" id="form-url"><div class="field"><label class="field-label">Website URL</label><input type="url" id="url-input" placeholder="https://example.com" value="https://example.com"></div></div>
                    <div class="form-content hidden" id="form-text"><div class="field"><label class="field-label">Text Content</label><textarea id="text-input" placeholder="Enter your text here..."></textarea></div></div>
                    <div class="form-content hidden" id="form-vcard">
                        <div class="field-row"><div class="field"><label class="field-label">First Name</label><input type="text" id="vcard-firstname" placeholder="John"></div><div class="field"><label class="field-label">Last Name</label><input type="text" id="vcard-lastname" placeholder="Doe"></div></div>
                        <div class="field"><label class="field-label">Company</label><input type="text" id="vcard-company" placeholder="Acme Inc."></div>
                        <div class="field"><label class="field-label">Job Title</label><input type="text" id="vcard-title" placeholder="Software Engineer"></div>
                        <div class="field"><label class="field-label">Phone</label><input type="tel" id="vcard-phone" placeholder="+1 234 567 8900"></div>
                        <div class="field"><label class="field-label">Email</label><input type="email" id="vcard-email" placeholder="john@example.com"></div>
                        <div class="field"><label class="field-label">Website</label><input type="url" id="vcard-website" placeholder="https://example.com"></div>
                        <div class="field"><label class="field-label">Address</label><textarea id="vcard-address" placeholder="123 Main St&#10;City, State 12345"></textarea></div>
                    </div>
                    <div class="form-content hidden" id="form-wifi">
                        <div class="field"><label class="field-label">Network Name (SSID)</label><input type="text" id="wifi-ssid" placeholder="MyNetwork"></div>
                        <div class="field"><label class="field-label">Password</label><input type="text" id="wifi-password" placeholder="Enter password"></div>
                        <div class="field"><label class="field-label">Security Type</label><select id="wifi-security"><option value="WPA">WPA/WPA2</option><option value="WEP">WEP</option><option value="nopass">None (Open)</option></select></div>
                        <div class="field"><label class="checkbox-field"><input type="checkbox" id="wifi-hidden">Hidden Network</label></div>
                    </div>
                    <div class="form-content hidden" id="form-email">
                        <div class="field"><label class="field-label">Email Address</label><input type="email" id="email-address" placeholder="contact@example.com"></div>
                        <div class="field"><label class="field-label">Subject</label><input type="text" id="email-subject" placeholder="Hello!"></div>
                        <div class="field"><label class="field-label">Message Body</label><textarea id="email-body" placeholder="Your message..."></textarea></div>
                    </div>
                    <div class="form-content hidden" id="form-sms">
                        <div class="field"><label class="field-label">Phone Number</label><input type="tel" id="sms-phone" placeholder="+1 234 567 8900"></div>
                        <div class="field"><label class="field-label">Message</label><textarea id="sms-message" placeholder="Your message..."></textarea></div>
                    </div>
                    <div class="form-content hidden" id="form-phone"><div class="field"><label class="field-label">Phone Number</label><input type="tel" id="phone-number" placeholder="+1 234 567 8900"></div></div>
                    <div class="form-content hidden" id="form-geo">
                        <div class="field-row"><div class="field"><label class="field-label">Latitude</label><input type="text" id="geo-lat" placeholder="40.7128"></div><div class="field"><label class="field-label">Longitude</label><input type="text" id="geo-lng" placeholder="-74.0060"></div></div>
                        <div class="field"><label class="field-label">Location Name (optional)</label><input type="text" id="geo-name" placeholder="New York City"></div>
                    </div>
                </div>
            </div>

            <div class="section open" id="stylingSection">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.555C21.965 6.012 17.461 2 12 2z"/></svg>Styling</div>
                    <svg class="section-toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div class="section-content">
                    <div class="field"><label class="field-label">Foreground Color</label><div class="color-field"><div class="color-picker-wrapper"><input type="color" id="fgColor" value="#000000"></div><input type="text" class="color-hex" id="fgColorHex" value="#000000" maxlength="7"></div></div>
                    <div class="field"><label class="field-label">Background Color</label><div class="color-field"><div class="color-picker-wrapper"><input type="color" id="bgColor" value="#ffffff"></div><input type="text" class="color-hex" id="bgColorHex" value="#ffffff" maxlength="7"></div><label class="checkbox-field" style="margin-top: 0.5rem;"><input type="checkbox" id="transparentBg">Transparent Background</label></div>
                    <div class="field"><label class="field-label">Dot Style</label><div class="style-grid" id="dotStyleGrid"><button class="style-option active" data-style="square" title="Square"><svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" fill="currentColor"/></svg></button><button class="style-option" data-style="dots" title="Dots"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="6" fill="currentColor"/></svg></button><button class="style-option" data-style="rounded" title="Rounded"><svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="3" fill="currentColor"/></svg></button><button class="style-option" data-style="extra-rounded" title="Extra Rounded"><svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="5" fill="currentColor"/></svg></button><button class="style-option" data-style="classy" title="Classy"><svg viewBox="0 0 24 24"><path d="M6 12 L12 6 L18 12 L12 18 Z" fill="currentColor"/></svg></button></div></div>
                    <div class="field"><label class="field-label">Corner Square Style</label><div class="style-grid" id="cornerSquareStyleGrid"><button class="style-option active" data-style="square" title="Square"><svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" fill="none" stroke="currentColor" stroke-width="3"/></svg></button><button class="style-option" data-style="dot" title="Dot"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="8" fill="none" stroke="currentColor" stroke-width="3"/></svg></button><button class="style-option" data-style="extra-rounded" title="Extra Rounded"><svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="5" fill="none" stroke="currentColor" stroke-width="3"/></svg></button></div></div>
                    <div class="field"><label class="field-label">Corner Dot Style</label><div class="style-grid" id="cornerDotStyleGrid"><button class="style-option active" data-style="square" title="Square"><svg viewBox="0 0 24 24"><rect x="8" y="8" width="8" height="8" fill="currentColor"/></svg></button><button class="style-option" data-style="dot" title="Dot"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="4" fill="currentColor"/></svg></button></div></div>
                </div>
            </div>

            <div class="section" id="logoSection">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>Logo</div>
                    <svg class="section-toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div class="section-content">
                    <div class="logo-upload" id="logoUpload"><input type="file" id="logoInput" accept="image/*"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg><p>Click or drag to upload logo</p></div>
                    <div class="field hidden" id="logoSizeField" style="margin-top: 1rem;"><label class="field-label">Logo Size</label><div class="range-field"><input type="range" id="logoSize" min="0.1" max="0.5" step="0.05" value="0.3"><span class="range-value" id="logoSizeValue">30%</span></div></div>
                    <div class="field hidden" id="logoMarginField"><label class="field-label">Logo Margin</label><div class="range-field"><input type="range" id="logoMargin" min="0" max="20" step="1" value="5"><span class="range-value" id="logoMarginValue">5px</span></div></div>
                </div>
            </div>

            <div class="section" id="frameSection">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>Frame & Label</div>
                    <svg class="section-toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div class="section-content">
                    <div class="field"><label class="field-label">Label Text</label><input type="text" id="frameLabel" placeholder="SCAN ME" maxlength="30"></div>
                    <div class="field"><label class="field-label">Label Color</label><div class="color-field"><div class="color-picker-wrapper"><input type="color" id="frameLabelColor" value="#000000"></div><input type="text" class="color-hex" id="frameLabelColorHex" value="#000000" maxlength="7"></div></div>
                    <div class="field"><label class="field-label">Label Background</label><div class="color-field"><div class="color-picker-wrapper"><input type="color" id="frameLabelBg" value="#ffffff"></div><input type="text" class="color-hex" id="frameLabelBgHex" value="#ffffff" maxlength="7"></div></div>
                </div>
            </div>

            <div class="section" id="settingsSection">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>Advanced Settings</div>
                    <svg class="section-toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div class="section-content">
                    <div class="field"><label class="field-label">QR Code Size</label><div class="range-field"><input type="range" id="qrSize" min="100" max="1000" step="50" value="300"><span class="range-value" id="qrSizeValue">300px</span></div></div>
                    <div class="field"><label class="field-label">Error Correction Level</label><select id="ecLevel"><option value="L">Low (7%) - More data</option><option value="M" selected>Medium (15%) - Balanced</option><option value="Q">Quartile (25%) - Recommended for logos</option><option value="H">High (30%) - Best for logos</option></select></div>
                    <div class="field"><label class="field-label">Quiet Zone (Margin)</label><div class="range-field"><input type="range" id="quietZone" min="0" max="50" step="5" value="10"><span class="range-value" id="quietZoneValue">10px</span></div></div>
                </div>
            </div>
        </div>

        <div class="preview-panel">
            <div class="preview-container">
                <div class="qr-wrapper" id="qrWrapper"><div id="qr-code"></div></div>
                <div class="frame-label hidden" id="frameLabelPreview"></div>
            </div>
            <div class="status-bar">
                <div class="status-item" id="contrastStatus"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg><span>Good contrast</span></div>
                <div class="status-item capacity-bar"><span id="capacityLabel">Capacity: 0%</span><div class="capacity-bar-track"><div class="capacity-bar-fill" id="capacityFill" style="width: 0%"></div></div></div>
            </div>
            <div class="download-actions">
                <button class="btn" id="copyBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>Copy</button>
                <button class="btn btn-primary" id="downloadPngBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>PNG</button>
                <button class="btn" id="downloadSvgBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>SVG</button>
            </div>
        </div>
    </main>

    <div class="modal-overlay" id="savePresetModal">
        <div class="modal">
            <div class="modal-header"><span class="modal-title">Save Preset</span><button class="modal-close" onclick="closeModal('savePresetModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
            <div class="modal-body"><div class="field"><label class="field-label">Preset Name</label><input type="text" id="presetName" placeholder="My QR Preset"></div></div>
            <div class="modal-footer"><button class="btn" onclick="closeModal('savePresetModal')">Cancel</button><button class="btn btn-primary" id="savePresetConfirm">Save</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="loadPresetModal">
        <div class="modal">
            <div class="modal-header"><span class="modal-title">Load Preset</span><button class="modal-close" onclick="closeModal('loadPresetModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
            <div class="modal-body"><div class="preset-list" id="presetList"></div></div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>
    <input type="file" id="importInput" accept=".json" style="display: none;">

    <script src="https://unpkg.com/qr-code-styling@1.6.0-rc.1/lib/qr-code-styling.js"></script>
    <script>
        // Fallback CDN if unpkg fails
        if (typeof QRCodeStyling === 'undefined') {
            document.write('<script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.6.0-rc.1/lib/qr-code-styling.js"><\/script>');
        }
    </script>
    <script>
    // State
    const state = {
        type: 'url',
        styling: { fgColor: '#000000', bgColor: '#ffffff', transparentBg: false, dotStyle: 'square', cornerSquareStyle: 'square', cornerDotStyle: 'square' },
        logo: { data: null, size: 0.3, margin: 5 },
        frame: { label: '', labelColor: '#000000', labelBg: '#ffffff' },
        settings: { size: 300, ecLevel: 'M', quietZone: 10 }
    };
    let qrCode = null, debounceTimer = null;

    // Init
    document.addEventListener('DOMContentLoaded', () => {
        // Check if library loaded
        if (typeof QRCodeStyling === 'undefined') {
            document.getElementById('qr-code').innerHTML = '<p style="color: var(--error); padding: 2rem;">Failed to load QR library. Please refresh the page.</p>';
            return;
        }
        initTheme(); initEventListeners(); loadFromURL(); generateQR(); initPWA();
    });

    function initTheme() {
        const saved = localStorage.getItem('qr-theme');
        if (saved) { document.documentElement.setAttribute('data-theme', saved); updateThemeIcon(saved); }
        else if (window.matchMedia('(prefers-color-scheme: light)').matches) { document.documentElement.setAttribute('data-theme', 'light'); updateThemeIcon('light'); }
    }

    function updateThemeIcon(theme) {
        document.querySelector('.icon-sun').classList.toggle('hidden', theme === 'light');
        document.querySelector('.icon-moon').classList.toggle('hidden', theme !== 'light');
    }

    function initEventListeners() {
        document.querySelectorAll('.type-btn').forEach(btn => btn.addEventListener('click', () => selectType(btn.dataset.type)));
        document.querySelectorAll('.form-content input, .form-content textarea, .form-content select').forEach(input => input.addEventListener('input', debounceGenerate));
        
        setupColorSync('fgColor', 'fgColorHex');
        setupColorSync('bgColor', 'bgColorHex');
        setupColorSync('frameLabelColor', 'frameLabelColorHex');
        setupColorSync('frameLabelBg', 'frameLabelBgHex');
        
        document.getElementById('transparentBg').addEventListener('change', e => {
            state.styling.transparentBg = e.target.checked;
            document.getElementById('qrWrapper').classList.toggle('transparent-bg', e.target.checked);
            debounceGenerate();
        });
        
        setupStyleGrid('dotStyleGrid', s => { state.styling.dotStyle = s; debounceGenerate(); });
        setupStyleGrid('cornerSquareStyleGrid', s => { state.styling.cornerSquareStyle = s; debounceGenerate(); });
        setupStyleGrid('cornerDotStyleGrid', s => { state.styling.cornerDotStyle = s; debounceGenerate(); });
        
        const logoUpload = document.getElementById('logoUpload'), logoInput = document.getElementById('logoInput');
        logoUpload.addEventListener('click', () => logoInput.click());
        logoUpload.addEventListener('dragover', e => { e.preventDefault(); logoUpload.style.borderColor = 'var(--accent)'; });
        logoUpload.addEventListener('dragleave', () => logoUpload.style.borderColor = '');
        logoUpload.addEventListener('drop', e => { e.preventDefault(); logoUpload.style.borderColor = ''; if (e.dataTransfer.files[0]) handleLogoFile(e.dataTransfer.files[0]); });
        logoInput.addEventListener('change', e => { if (e.target.files[0]) handleLogoFile(e.target.files[0]); });
        
        document.getElementById('logoSize').addEventListener('input', e => { state.logo.size = parseFloat(e.target.value); document.getElementById('logoSizeValue').textContent = Math.round(state.logo.size * 100) + '%'; debounceGenerate(); });
        document.getElementById('logoMargin').addEventListener('input', e => { state.logo.margin = parseInt(e.target.value); document.getElementById('logoMarginValue').textContent = e.target.value + 'px'; debounceGenerate(); });
        document.getElementById('frameLabel').addEventListener('input', e => { state.frame.label = e.target.value; updateFramePreview(); });
        document.getElementById('qrSize').addEventListener('input', e => { state.settings.size = parseInt(e.target.value); document.getElementById('qrSizeValue').textContent = e.target.value + 'px'; debounceGenerate(); });
        document.getElementById('ecLevel').addEventListener('change', e => { state.settings.ecLevel = e.target.value; debounceGenerate(); });
        document.getElementById('quietZone').addEventListener('input', e => { state.settings.quietZone = parseInt(e.target.value); document.getElementById('quietZoneValue').textContent = e.target.value + 'px'; debounceGenerate(); });
        
        document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        setupDropdown('presetsDropdown', 'presetsBtn');
        setupDropdown('brandDropdown', 'brandBtn');
        
        document.getElementById('savePresetBtn').addEventListener('click', () => { closeDropdown('presetsDropdown'); openModal('savePresetModal'); });
        document.getElementById('loadPresetBtn').addEventListener('click', () => { closeDropdown('presetsDropdown'); showPresetList(); openModal('loadPresetModal'); });
        document.getElementById('exportPresetsBtn').addEventListener('click', () => { closeDropdown('presetsDropdown'); exportPresets(); });
        document.getElementById('importPresetsBtn').addEventListener('click', () => { closeDropdown('presetsDropdown'); document.getElementById('importInput').click(); });
        document.getElementById('importInput').addEventListener('change', importPresets);
        document.getElementById('savePresetConfirm').addEventListener('click', savePreset);
        
        document.getElementById('saveBrandBtn').addEventListener('click', () => { closeDropdown('brandDropdown'); saveBrand(); });
        document.getElementById('applyBrandBtn').addEventListener('click', () => { closeDropdown('brandDropdown'); applyBrand(); });
        document.getElementById('clearBrandBtn').addEventListener('click', () => { closeDropdown('brandDropdown'); clearBrand(); });
        
        document.getElementById('shareBtn').addEventListener('click', shareLink);
        document.getElementById('copyBtn').addEventListener('click', copyToClipboard);
        document.getElementById('downloadPngBtn').addEventListener('click', () => downloadQR('png'));
        document.getElementById('downloadSvgBtn').addEventListener('click', () => downloadQR('svg'));
        
        document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { if (e.target === o) o.classList.remove('open'); }));
        document.addEventListener('click', e => { if (!e.target.closest('.dropdown')) document.querySelectorAll('.dropdown.open').forEach(d => d.classList.remove('open')); });
    }

    // QR Generation
    function generateQR() {
        const data = getQRData();
        if (!data) return;
        const container = document.getElementById('qr-code');
        container.innerHTML = '';
        const options = {
            width: state.settings.size, height: state.settings.size, data, margin: state.settings.quietZone,
            dotsOptions: { color: state.styling.fgColor, type: state.styling.dotStyle },
            backgroundOptions: { color: state.styling.transparentBg ? 'transparent' : state.styling.bgColor },
            cornersSquareOptions: { color: state.styling.fgColor, type: state.styling.cornerSquareStyle },
            cornersDotOptions: { color: state.styling.fgColor, type: state.styling.cornerDotStyle },
            qrOptions: { errorCorrectionLevel: state.settings.ecLevel }
        };
        if (state.logo.data) {
            options.image = state.logo.data;
            options.imageOptions = { crossOrigin: 'anonymous', margin: state.logo.margin, imageSize: state.logo.size };
        }
        qrCode = new QRCodeStyling(options);
        qrCode.append(container);
        updateCapacity(data);
        checkContrast();
    }

    function getQRData() {
        switch (state.type) {
            case 'url': return document.getElementById('url-input').value || '';
            case 'text': return document.getElementById('text-input').value || '';
            case 'vcard': return generateVCard();
            case 'wifi': return generateWiFi();
            case 'email': return generateEmail();
            case 'sms': return generateSMS();
            case 'phone': const p = document.getElementById('phone-number').value; return p ? `tel:${p}` : '';
            case 'geo': return generateGeo();
            default: return '';
        }
    }

    function generateVCard() {
        const fn = document.getElementById('vcard-firstname').value, ln = document.getElementById('vcard-lastname').value;
        const company = document.getElementById('vcard-company').value, title = document.getElementById('vcard-title').value;
        const phone = document.getElementById('vcard-phone').value, email = document.getElementById('vcard-email').value;
        const website = document.getElementById('vcard-website').value, address = document.getElementById('vcard-address').value;
        let v = 'BEGIN:VCARD\nVERSION:3.0\n';
        if (fn || ln) v += `N:${ln};${fn};;;\nFN:${fn} ${ln}\n`;
        if (company) v += `ORG:${company}\n`; if (title) v += `TITLE:${title}\n`;
        if (phone) v += `TEL:${phone}\n`; if (email) v += `EMAIL:${email}\n`;
        if (website) v += `URL:${website}\n`; if (address) v += `ADR:;;${address.replace(/\n/g, ';')};;;;\n`;
        return v + 'END:VCARD';
    }

    function generateWiFi() {
        const ssid = document.getElementById('wifi-ssid').value, pass = document.getElementById('wifi-password').value;
        const sec = document.getElementById('wifi-security').value, hidden = document.getElementById('wifi-hidden').checked;
        if (!ssid) return '';
        let w = `WIFI:T:${sec};S:${ssid};`;
        if (pass && sec !== 'nopass') w += `P:${pass};`;
        if (hidden) w += 'H:true;';
        return w + ';';
    }

    function generateEmail() {
        const addr = document.getElementById('email-address').value, subj = document.getElementById('email-subject').value, body = document.getElementById('email-body').value;
        if (!addr) return '';
        let e = `mailto:${addr}`, params = [];
        if (subj) params.push(`subject=${encodeURIComponent(subj)}`);
        if (body) params.push(`body=${encodeURIComponent(body)}`);
        return params.length ? e + '?' + params.join('&') : e;
    }

    function generateSMS() {
        const phone = document.getElementById('sms-phone').value, msg = document.getElementById('sms-message').value;
        if (!phone) return '';
        return msg ? `sms:${phone}?body=${encodeURIComponent(msg)}` : `sms:${phone}`;
    }

    function generateGeo() {
        const lat = document.getElementById('geo-lat').value, lng = document.getElementById('geo-lng').value, name = document.getElementById('geo-name').value;
        if (!lat || !lng) return '';
        return name ? `geo:${lat},${lng}?q=${encodeURIComponent(name)}` : `geo:${lat},${lng}`;
    }

    function debounceGenerate() { clearTimeout(debounceTimer); debounceTimer = setTimeout(generateQR, 150); }

    // UI Helpers
    function selectType(type) {
        state.type = type;
        document.querySelectorAll('.type-btn').forEach(b => b.classList.toggle('active', b.dataset.type === type));
        document.querySelectorAll('.form-content').forEach(f => f.classList.add('hidden'));
        document.getElementById(`form-${type}`).classList.remove('hidden');
        debounceGenerate();
    }

    function toggleSection(header) { header.closest('.section').classList.toggle('open'); }

    function setupColorSync(pickerId, hexId) {
        const picker = document.getElementById(pickerId), hex = document.getElementById(hexId);
        picker.addEventListener('input', e => { hex.value = e.target.value.toUpperCase(); updateColorState(pickerId, e.target.value); debounceGenerate(); });
        hex.addEventListener('input', e => {
            let v = e.target.value; if (!v.startsWith('#')) v = '#' + v;
            if (/^#[0-9A-Fa-f]{6}$/.test(v)) { picker.value = v; updateColorState(pickerId, v); debounceGenerate(); }
        });
    }

    function updateColorState(id, val) {
        if (id === 'fgColor') state.styling.fgColor = val;
        else if (id === 'bgColor') state.styling.bgColor = val;
        else if (id === 'frameLabelColor') { state.frame.labelColor = val; updateFramePreview(); }
        else if (id === 'frameLabelBg') { state.frame.labelBg = val; updateFramePreview(); }
    }

    function setupStyleGrid(gridId, cb) {
        const grid = document.getElementById(gridId);
        grid.querySelectorAll('.style-option').forEach(opt => opt.addEventListener('click', () => {
            grid.querySelectorAll('.style-option').forEach(o => o.classList.remove('active'));
            opt.classList.add('active'); cb(opt.dataset.style);
        }));
    }

    function setupDropdown(dropdownId, buttonId) {
        const dropdown = document.getElementById(dropdownId);
        document.getElementById(buttonId).addEventListener('click', e => {
            e.stopPropagation();
            document.querySelectorAll('.dropdown.open').forEach(d => { if (d !== dropdown) d.classList.remove('open'); });
            dropdown.classList.toggle('open');
        });
    }

    function closeDropdown(id) { document.getElementById(id).classList.remove('open'); }
    function openModal(id) { document.getElementById(id).classList.add('open'); }
    function closeModal(id) { document.getElementById(id).classList.remove('open'); }

    function toggleTheme() {
        const next = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('qr-theme', next);
        updateThemeIcon(next);
    }

    // Logo
    function handleLogoFile(file) {
        if (!file.type.startsWith('image/')) { showToast('Please upload an image file', 'error'); return; }
        const reader = new FileReader();
        reader.onload = e => {
            state.logo.data = e.target.result;
            const lu = document.getElementById('logoUpload');
            lu.classList.add('has-logo');
            lu.innerHTML = `<input type="file" id="logoInput" accept="image/*"><div class="logo-preview"><img src="${e.target.result}" alt="Logo"><div class="logo-preview-info"><div class="logo-preview-name">${file.name}</div><span class="logo-preview-remove" onclick="removeLogo(event)">Remove</span></div></div>`;
            document.getElementById('logoInput').addEventListener('change', ev => { if (ev.target.files[0]) handleLogoFile(ev.target.files[0]); });
            document.getElementById('logoSizeField').classList.remove('hidden');
            document.getElementById('logoMarginField').classList.remove('hidden');
            if (state.settings.ecLevel === 'L' || state.settings.ecLevel === 'M') {
                state.settings.ecLevel = 'Q'; document.getElementById('ecLevel').value = 'Q';
                showToast('Error correction increased for better logo scanning', 'success');
            }
            debounceGenerate();
        };
        reader.readAsDataURL(file);
    }

    function removeLogo(e) {
        e.stopPropagation(); state.logo.data = null;
        const lu = document.getElementById('logoUpload');
        lu.classList.remove('has-logo');
        lu.innerHTML = `<input type="file" id="logoInput" accept="image/*"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg><p>Click or drag to upload logo</p>`;
        document.getElementById('logoInput').addEventListener('change', ev => { if (ev.target.files[0]) handleLogoFile(ev.target.files[0]); });
        document.getElementById('logoSizeField').classList.add('hidden');
        document.getElementById('logoMarginField').classList.add('hidden');
        debounceGenerate();
    }

    function updateFramePreview() {
        const preview = document.getElementById('frameLabelPreview');
        if (state.frame.label) {
            preview.textContent = state.frame.label;
            preview.style.color = state.frame.labelColor;
            preview.style.background = state.frame.labelBg;
            preview.classList.remove('hidden');
        } else preview.classList.add('hidden');
    }

    // Status
    function updateCapacity(data) {
        const maxCap = { L: 2953, M: 2331, Q: 1663, H: 1273 };
        const pct = Math.min(100, Math.round((data.length / maxCap[state.settings.ecLevel]) * 100));
        document.getElementById('capacityLabel').textContent = `Capacity: ${pct}%`;
        const fill = document.getElementById('capacityFill');
        fill.style.width = pct + '%';
        fill.className = 'capacity-bar-fill' + (pct > 90 ? ' error' : pct > 70 ? ' warning' : '');
    }

    function checkContrast() {
        const fg = state.styling.fgColor, bg = state.styling.transparentBg ? '#ffffff' : state.styling.bgColor;
        const lum = c => { const rgb = [parseInt(c.slice(1,3),16), parseInt(c.slice(3,5),16), parseInt(c.slice(5,7),16)].map(v => { v /= 255; return v <= 0.03928 ? v/12.92 : Math.pow((v+0.055)/1.055, 2.4); }); return 0.2126*rgb[0] + 0.7152*rgb[1] + 0.0722*rgb[2]; };
        const l1 = lum(fg), l2 = lum(bg);
        const ratio = (Math.max(l1, l2) + 0.05) / (Math.min(l1, l2) + 0.05);
        const status = document.getElementById('contrastStatus');
        if (ratio < 3) { status.className = 'status-item status-error'; status.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg><span>Poor contrast - may not scan</span>'; }
        else if (ratio < 4.5) { status.className = 'status-item status-warning'; status.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg><span>Low contrast</span>'; }
        else { status.className = 'status-item status-ok'; status.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg><span>Good contrast</span>'; }
    }

    // Download & Share
    async function downloadQR(type) {
        if (!qrCode) return;
        const ext = type === 'svg' ? 'svg' : 'png';
        qrCode.download({ name: `qr-code-${Date.now()}`, extension: ext });
        showToast(`QR code downloaded as ${ext.toUpperCase()}`, 'success');
    }

    async function copyToClipboard() {
        if (!qrCode) return;
        try {
            const canvas = document.querySelector('#qr-code canvas');
            if (!canvas) { showToast('Generate a QR code first', 'error'); return; }
            const blob = await new Promise(r => canvas.toBlob(r));
            await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
            showToast('Copied to clipboard', 'success');
        } catch { showToast('Failed to copy', 'error'); }
    }

    function shareLink() {
        const config = { t: state.type, s: state.styling, st: state.settings, f: state.frame };
        const hash = btoa(JSON.stringify(config));
        const url = `${location.origin}${location.pathname}#${hash}`;
        navigator.clipboard.writeText(url).then(() => showToast('Share link copied!', 'success')).catch(() => showToast('Failed to copy link', 'error'));
    }

    function loadFromURL() {
        if (!location.hash) return;
        try {
            const config = JSON.parse(atob(location.hash.slice(1)));
            if (config.t) { state.type = config.t; selectType(config.t); }
            if (config.s) { Object.assign(state.styling, config.s); applyStyleToUI(); }
            if (config.st) { Object.assign(state.settings, config.st); applySettingsToUI(); }
            if (config.f) { Object.assign(state.frame, config.f); applyFrameToUI(); }
        } catch {}
    }

    function applyStyleToUI() {
        document.getElementById('fgColor').value = state.styling.fgColor;
        document.getElementById('fgColorHex').value = state.styling.fgColor;
        document.getElementById('bgColor').value = state.styling.bgColor;
        document.getElementById('bgColorHex').value = state.styling.bgColor;
        document.getElementById('transparentBg').checked = state.styling.transparentBg;
        document.querySelectorAll('#dotStyleGrid .style-option').forEach(o => o.classList.toggle('active', o.dataset.style === state.styling.dotStyle));
        document.querySelectorAll('#cornerSquareStyleGrid .style-option').forEach(o => o.classList.toggle('active', o.dataset.style === state.styling.cornerSquareStyle));
        document.querySelectorAll('#cornerDotStyleGrid .style-option').forEach(o => o.classList.toggle('active', o.dataset.style === state.styling.cornerDotStyle));
    }

    function applySettingsToUI() {
        document.getElementById('qrSize').value = state.settings.size;
        document.getElementById('qrSizeValue').textContent = state.settings.size + 'px';
        document.getElementById('ecLevel').value = state.settings.ecLevel;
        document.getElementById('quietZone').value = state.settings.quietZone;
        document.getElementById('quietZoneValue').textContent = state.settings.quietZone + 'px';
    }

    function applyFrameToUI() {
        document.getElementById('frameLabel').value = state.frame.label;
        document.getElementById('frameLabelColor').value = state.frame.labelColor;
        document.getElementById('frameLabelColorHex').value = state.frame.labelColor;
        document.getElementById('frameLabelBg').value = state.frame.labelBg;
        document.getElementById('frameLabelBgHex').value = state.frame.labelBg;
        updateFramePreview();
    }

    // Presets
    function getPresets() { return JSON.parse(localStorage.getItem('qr-presets') || '[]'); }
    function savePresets(p) { localStorage.setItem('qr-presets', JSON.stringify(p)); }

    function savePreset() {
        const name = document.getElementById('presetName').value.trim();
        if (!name) { showToast('Please enter a preset name', 'error'); return; }
        const presets = getPresets();
        presets.push({ id: Date.now().toString(), name, type: state.type, styling: {...state.styling}, settings: {...state.settings}, frame: {...state.frame}, logo: state.logo.data ? { size: state.logo.size, margin: state.logo.margin } : null });
        savePresets(presets);
        closeModal('savePresetModal');
        document.getElementById('presetName').value = '';
        showToast('Preset saved!', 'success');
    }

    function showPresetList() {
        const list = document.getElementById('presetList'), presets = getPresets();
        if (!presets.length) { list.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg><p>No presets saved yet</p></div>'; return; }
        list.innerHTML = presets.map(p => `<div class="preset-item" onclick="loadPreset('${p.id}')"><div class="preset-preview">ðŸ“±</div><div class="preset-info"><div class="preset-name">${p.name}</div><div class="preset-type">${p.type}</div></div><button class="preset-delete" onclick="deletePreset(event, '${p.id}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button></div>`).join('');
    }

    function loadPreset(id) {
        const preset = getPresets().find(p => p.id === id);
        if (!preset) return;
        state.type = preset.type; state.styling = {...preset.styling}; state.settings = {...preset.settings}; state.frame = {...preset.frame};
        selectType(preset.type); applyStyleToUI(); applySettingsToUI(); applyFrameToUI();
        closeModal('loadPresetModal');
        generateQR();
        showToast('Preset loaded!', 'success');
    }

    function deletePreset(e, id) {
        e.stopPropagation();
        savePresets(getPresets().filter(p => p.id !== id));
        showPresetList();
        showToast('Preset deleted', 'success');
    }

    function exportPresets() {
        const data = JSON.stringify({ presets: getPresets(), brand: getBrand() }, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'qr-studio-backup.json'; a.click();
        showToast('Presets exported!', 'success');
    }

    function importPresets(e) {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
            try {
                const data = JSON.parse(ev.target.result);
                if (data.presets) savePresets([...getPresets(), ...data.presets]);
                if (data.brand) saveBrandData(data.brand);
                showToast('Import successful!', 'success');
            } catch { showToast('Invalid file format', 'error'); }
        };
        reader.readAsText(file);
        e.target.value = '';
    }

    // Brand Kit
    function getBrand() { return JSON.parse(localStorage.getItem('qr-brand') || 'null'); }
    function saveBrandData(b) { localStorage.setItem('qr-brand', JSON.stringify(b)); }

    function saveBrand() {
        saveBrandData({ fgColor: state.styling.fgColor, bgColor: state.styling.bgColor, logo: state.logo.data, logoSize: state.logo.size, logoMargin: state.logo.margin });
        showToast('Brand kit saved!', 'success');
    }

    function applyBrand() {
        const brand = getBrand();
        if (!brand) { showToast('No brand kit saved', 'error'); return; }
        state.styling.fgColor = brand.fgColor; state.styling.bgColor = brand.bgColor;
        if (brand.logo) { state.logo.data = brand.logo; state.logo.size = brand.logoSize; state.logo.margin = brand.logoMargin; }
        applyStyleToUI();
        if (brand.logo) {
            document.getElementById('logoSizeField').classList.remove('hidden');
            document.getElementById('logoMarginField').classList.remove('hidden');
            document.getElementById('logoSize').value = brand.logoSize;
            document.getElementById('logoSizeValue').textContent = Math.round(brand.logoSize * 100) + '%';
            document.getElementById('logoMargin').value = brand.logoMargin;
            document.getElementById('logoMarginValue').textContent = brand.logoMargin + 'px';
        }
        generateQR();
        showToast('Brand applied!', 'success');
    }

    function clearBrand() { localStorage.removeItem('qr-brand'); showToast('Brand kit cleared', 'success'); }

    // Toast
    function showToast(msg, type = 'success') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = type === 'success' ? `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg><span>${msg}</span>` : `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg><span>${msg}</span>`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // PWA
    let deferredPrompt = null;
    function initPWA() {
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(() => {});
        window.addEventListener('beforeinstallprompt', e => {
            e.preventDefault(); deferredPrompt = e;
            if (!localStorage.getItem('pwa-dismissed')) document.getElementById('installBanner').classList.add('show');
        });
        document.getElementById('installBtn').addEventListener('click', async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            await deferredPrompt.userChoice;
            deferredPrompt = null;
            document.getElementById('installBanner').classList.remove('show');
        });
        document.getElementById('dismissInstall').addEventListener('click', () => {
            document.getElementById('installBanner').classList.remove('show');
            localStorage.setItem('pwa-dismissed', 'true');
        });
    }
    </script>
</body>
</html>